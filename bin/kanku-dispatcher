#!/usr/bin/env perl


use strict;
use warnings;
use FindBin;
use lib "$FindBin::Bin/../lib";
use Path::Class qw/dir file/;
use Data::Dumper;

use Kanku::Config;
use Kanku::Scheduler;
use Kanku::Schema;
use YAML;
use JSON::XS;
use Log::Log4perl;

chdir("$FindBin::Bin/..");

Log::Log4perl->init("$FindBin::Bin/../etc/log4perl.conf");
my $logger = Log::Log4perl->get_logger();

Kanku::Config->initialize();

my $cfg = Kanku::Config->instance();

my $cfg_file    = file($FindBin::Bin,'..','config.yml');
my $cfg_content = $cfg_file->slurp;
my $cfg_yaml    = YAML::Load($cfg_content);
my $schema      = Kanku::Schema->connect($cfg_yaml->{plugins}->{DBIC}->{default}->{dsn});

my $kcfg_file    = file($FindBin::Bin,'..','etc','config.yml');
my $kcfg_content = $kcfg_file->slurp;
my $kcfg_yaml    = YAML::Load($kcfg_content);
my $mod         = $kcfg_yaml->{dispatcher} || "Kanku::Dispatch::Local";
$logger->debug(Dumper($kcfg_yaml));
$logger->debug("Using module $mod");
my $mod2require = $mod;
$mod2require =~ s|::|/|g;
$mod2require = $mod2require . ".pm";
require "$mod2require";


my $dispatcher = $mod->new(schema=>$schema);

$dispatcher->run();

exit 0;
