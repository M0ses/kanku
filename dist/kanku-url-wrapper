#!/bin/bash

URL=$1
URL=${URL//kanku:\/\//}

#if [ "$KANKU_HANDLER_RUNNING_IN_TERMINAL" != "1" ];then
#  echo "starting in terminal '$0 $@'" >> /tmp/kanku.log
#  export KANKU_HANDLER_RUNNING_IN_TERMINAL=1
#  xdg-terminal "export KANKU_HANDLER_RUNNING_IN_TERMINAL=1;$0 $@"
#else

  if [ -z "$URL" ];then
    echo "No url given!"
    read
    exit
  fi

  TEMP_DIR=`mktemp -d`
  KANKU_FILE="$TEMP_DIR/KankuFile"
  curl -L -o $KANKU_FILE "$URL"

  cd $TEMP_DIR

  DOMAIN_NAME=`grep "^domain_name:" ./KankuFile`
  EXISTS=`virsh list --name --all|grep ${DOMAIN_NAME//domain_name:/}`

  if [ -n "$EXISTS" ];then
    echo "$DOMAIN_NAME already exits!"
    echo
    echo "1) reconfigure KankuFile"
    echo "2) remove domain"
    echo "*) exit"
    read sel
    case $sel in
      1)
        echo "Enter new name: "
        read name
        perl -p -i -e "s/$DOMAIN_NAME/domain_name: $name/" KankuFile
      ;;
      2)
        kanku destroy
      ;;
      *)
        exit
      ;;
    esac
  fi

  kanku up
  echo "Keep shell alive? (y|Y|n|N)"
  read sel
  case $sel in
    y|Y)
      bash
    ;;
  esac
#fi

exit 0
